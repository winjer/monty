name: ci

on:
  push:
    branches:
      - main
    tags:
      - "**"
  pull_request: {}

env:
  COLUMNS: 150
  UV_PYTHON: "3.14"
  UV_FROZEN: "1"

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - uses: astral-sh/setup-uv@v7
      - run: uv sync --all-packages --only-dev

      - uses: actions/cache@v5
        with:
          path: ~/.cache/pre-commit
          key: pre-commit|${{ env.UV_PYTHON }}|${{ hashFiles('.pre-commit-config.yaml') }}
      - run: uvx pre-commit run --color=always --all-files --verbose
        env:
          SKIP: test

  test-rust:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools
      - uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - uses: taiki-e/install-action@cargo-llvm-cov

      # this means pyo3 will use Python 3.14 in tests
      - uses: actions/setup-python@v6
        with:
          python-version: "3.14"

      - run: rustc --version --verbose
      - run: python3 -V
        # don't use .venv python in CI
      - run: rm .cargo/config.toml

      # run rust tests with coverage
      - run: make testcov

  test-python:
    name: test python ${{ matrix.python-version }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13", "3.14"]

    env:
      UV_PYTHON: ${{ matrix.python-version }}

    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
      - uses: astral-sh/setup-uv@v7

      - run: uv sync --all-packages --only-dev
      - run: make dev-py
      - run: make pytest
        # also test with a release build
      - run: make dev-py-release
      - run: make pytest
        # test uv run exercise script
      - run: uv run crates/monty-python/exercise.py

  bench-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - uses: actions/setup-python@v6
        with:
          python-version: "3.14"
        # don't use .venv python in CI
      - run: rm .cargo/config.toml

      - run: make dev-bench

  # https://github.com/marketplace/actions/alls-green#why used for branch protection checks
  check:
    if: always()
    needs: [lint, test-rust, test-python, bench-test]
    runs-on: ubuntu-latest
    steps:
      - name: Decide whether the needed jobs succeeded or failed
        uses: re-actors/alls-green@release/v1
        with:
          jobs: ${{ toJSON(needs) }}

  # Build wheels for exotic architectures (non-PGO)
  build:
    name: build on ${{ matrix.os }} (${{ matrix.target }} - ${{ matrix.manylinux || 'auto' }})
    # only run on push to main, on tags, or if 'Full Build' label is present
    if: startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main' || contains(github.event.pull_request.labels.*.name, 'Full Build')
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux aarch64
          - os: linux
            target: aarch64
          # Linux i686
          - os: linux
            target: i686
          # Linux armv7
          - os: linux
            target: armv7
          # Linux ppc64le
          - os: linux
            target: ppc64le
          # Linux s390x
          - os: linux
            target: s390x
          # Linux x86_64 musl
          - os: linux
            target: x86_64
            manylinux: musllinux_1_1
          # Linux aarch64 musl
          - os: linux
            target: aarch64
            manylinux: musllinux_1_1
          # macOS x86_64 (Intel)
          - os: macos
            target: x86_64
          # Windows i686
          - os: windows
            target: i686

    runs-on: ${{ (matrix.os == 'linux' && 'ubuntu-latest') || (matrix.os == 'macos' && 'macos-latest') || (matrix.os == 'windows' && 'windows-latest') }}
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - run: pip install -U twine

      - name: build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          manylinux: ${{ matrix.manylinux || 'auto' }}
          args: --release --out dist -i 3.10 3.11 3.12 3.13 3.14
          rust-toolchain: stable
          docker-options: -e CI
          working-directory: crates/monty-python

      - run: twine check --strict crates/monty-python/dist/*

      - uses: actions/upload-artifact@v4
        with:
          name: pypi_files-${{ matrix.os }}-${{ matrix.target }}-${{ matrix.manylinux || 'manylinux' }}
          path: crates/monty-python/dist

  # PGO-optimized builds for main platforms
  build-pgo:
    name: build pgo on ${{ matrix.os }}
    # only run on push to main, on tags, or if 'Full Build' label is present
    if: startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main' || contains(github.event.pull_request.labels.*.name, 'Full Build')
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64 (manylinux)
          - os: linux
            runs-on: ubuntu-latest
            interpreter: 3.10 3.11 3.12 3.13 3.14
          # Windows x86_64
          - os: windows
            runs-on: windows-latest
            interpreter: 3.10 3.11 3.12 3.13 3.14
          # macOS aarch64 (Apple Silicon)
          - os: macos
            runs-on: macos-latest
            interpreter: 3.10 3.11 3.12 3.13 3.14

    runs-on: ${{ matrix.runs-on }}

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools

      - run: pip install -U twine

      - name: build PGO wheel
        id: pgo
        uses: ./.github/actions/build-pgo-wheel
        with:
          interpreter: ${{ matrix.interpreter }}
          rust-toolchain: stable

      - run: twine check --strict ${{ steps.pgo.outputs.wheel-dir }}/*

      - uses: actions/upload-artifact@v4
        with:
          name: pypi_files-${{ matrix.os }}-pgo
          path: ${{ steps.pgo.outputs.wheel-dir }}

  # Inspect built artifacts
  inspect-pypi-assets:
    needs: [build, build-pgo]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: pypi_files-*
          merge-multiple: true
          path: dist

      - name: list files
        run: |
          ls -lhR dist/
          ls -1 dist/ | wc -l
          echo "Expected ~50 wheel files (5 Python versions Ã— 10 platform variants)"

  # Test wheels on exotic architectures via QEMU
  test-builds-arch:
    name: test build on ${{ matrix.target }}
    needs: [build]
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        target: [aarch64, armv7, s390x, ppc64le]

    steps:
      - uses: actions/checkout@v6

      - uses: actions/download-artifact@v4
        with:
          pattern: pypi_files-linux-${{ matrix.target }}-*
          merge-multiple: true
          path: dist

      - uses: uraimo/run-on-arch-action@v3
        name: install & test
        with:
          arch: ${{ matrix.target }}
          distro: ubuntu22.04
          dockerRunArgs: --volume "${{ github.workspace }}/dist:/dist"
          install: |
            apt-get update
            apt-get install -y --no-install-recommends python3 python3-pip python3-venv
          run: |
            ls -lh /dist/
            python3 -m venv venv
            source venv/bin/activate
            python3 -m pip install monty-python --no-index --no-deps --find-links /dist --force-reinstall
            python3 -c "import monty; print(monty.Monty('1 + 2').run())"

  # Test wheels on main OS platforms
  test-builds-os:
    name: test build on ${{ matrix.os }}
    needs: [build, build-pgo]
    runs-on: ${{ matrix.runs-on }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            runs-on: ubuntu-latest
          - os: macos
            runs-on: macos-latest
          - os: windows
            runs-on: windows-latest

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - uses: actions/download-artifact@v4
        with:
          pattern: pypi_files-${{ matrix.os }}-*
          merge-multiple: true
          path: dist

      - run: pip install monty-python --no-index --find-links dist --force-reinstall
      - run: python -c "import monty; print(monty.Monty('1 + 2').run())"

  # Release to PyPI
  release-python:
    name: release to PyPI
    needs: [check, build, build-pgo, test-builds-arch, test-builds-os]
    if: success() && startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    environment: release-python

    permissions:
      id-token: write

    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: pypi_files-*
          merge-multiple: true
          path: dist

      - name: list files
        run: ls -lhR dist/

      - uses: pypa/gh-action-pypi-publish@release/v1
