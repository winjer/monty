name: ci

on:
  push:
    branches:
      - main
    tags:
      - "**"
  pull_request: {}

env:
  COLUMNS: 150
  UV_PYTHON: "3.14"
  UV_FROZEN: "1"
  DEBUG: "napi:*"

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
          prefix-key: "v1-rust"

      - uses: astral-sh/setup-uv@v7
      - run: uv sync --all-packages --only-dev

      - uses: actions/cache@v5
        with:
          path: ~/.cache/pre-commit
          key: pre-commit|${{ env.UV_PYTHON }}|${{ hashFiles('.pre-commit-config.yaml') }}

      - name: Setup node
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: npm
          cache-dependency-path: crates/monty-js/package-lock.json

      - name: Install dependencies
        run: npm install
        working-directory: crates/monty-js

      - run: uvx pre-commit run --color=always --all-files --verbose
        env:
          SKIP: test

      - name: Show diff on failure
        if: failure()
        run: git diff

  test-rust:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools
      - uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - uses: taiki-e/install-action@cargo-llvm-cov

      # this means pyo3 will use Python 3.14 in tests
      - uses: actions/setup-python@v6
        with:
          python-version: "3.14"

      - run: rustc --version --verbose
      - run: python3 -V
        # don't use .venv python in CI
      - run: rm .cargo/config.toml

      # run rust tests with coverage
      - run: make testcov

  test-python:
    name: test python ${{ matrix.python-version }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13", "3.14"]

    env:
      UV_PYTHON: ${{ matrix.python-version }}

    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
      - uses: astral-sh/setup-uv@v7

      - run: uv sync --all-packages --only-dev
      - run: make dev-py
      - run: make pytest
        # also test with a release build
      - run: make dev-py-release
      - run: make pytest
        # test uv run exercise script
      - run: uv run crates/monty-python/exercise.py

  bench-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - uses: actions/setup-python@v6
        with:
          python-version: "3.14"
          # don't use .venv python in CI
      - run: rm .cargo/config.toml

      - run: make dev-bench

  # https://github.com/marketplace/actions/alls-green#why used for branch protection checks
  check:
    if: always()
    needs: [lint, test-rust, test-python, bench-test]
    runs-on: ubuntu-latest
    steps:
      - name: Decide whether the needed jobs succeeded or failed
        uses: re-actors/alls-green@release/v1
        with:
          jobs: ${{ toJSON(needs) }}

  # Build source distribution
  build-sdist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: "3.12"
      - uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist
          rust-toolchain: stable
          working-directory: crates/monty-python
      - uses: actions/upload-artifact@v4
        with:
          name: pypi_files-sdist
          path: crates/monty-python/dist

  # Build wheels for exotic architectures (non-PGO)
  build:
    name: build on ${{ matrix.os }} (${{ matrix.target }} - ${{ matrix.manylinux || 'auto' }})
    # only run on push to main, on tags, or if 'Full Build' label is present
    if: startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main' || contains(github.event.pull_request.labels.*.name, 'Full Build')
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux aarch64
          - os: linux
            target: aarch64
          # Linux i686
          - os: linux
            target: i686
          # Linux armv7
          - os: linux
            target: armv7
          # Linux ppc64le
          - os: linux
            target: ppc64le
          # Linux s390x
          - os: linux
            target: s390x
          # Linux x86_64 musl
          - os: linux
            target: x86_64
            manylinux: musllinux_1_1
          # Linux aarch64 musl
          - os: linux
            target: aarch64
            manylinux: musllinux_1_1
          # macOS x86_64 (Intel)
          - os: macos
            target: x86_64
          # Windows i686
          - os: windows
            target: i686

    runs-on: ${{ (matrix.os == 'linux' && 'ubuntu-latest') || (matrix.os == 'macos' && 'macos-latest') || (matrix.os == 'windows' && 'windows-latest') }}
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          manylinux: ${{ matrix.manylinux || 'auto' }}
          args: --release --out dist -i 3.10 3.11 3.12 3.13 3.14
          rust-toolchain: stable
          docker-options: -e CI
          working-directory: crates/monty-python

      - uses: actions/upload-artifact@v4
        with:
          name: pypi_files-${{ matrix.os }}-${{ matrix.target }}-${{ matrix.manylinux || 'manylinux' }}
          path: crates/monty-python/dist

  # PGO-optimized builds for main platforms
  build-pgo:
    name: build pgo on ${{ matrix.os }}
    # only run on push to main, on tags, or if 'Full Build' label is present
    if: startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main' || contains(github.event.pull_request.labels.*.name, 'Full Build')
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64 (manylinux)
          - os: linux
            runs-on: ubuntu-latest
            interpreter: 3.10 3.11 3.12 3.13 3.14
          # Windows x86_64
          - os: windows
            runs-on: windows-latest
            interpreter: 3.10 3.11 3.12 3.13 3.14
          # macOS aarch64 (Apple Silicon)
          - os: macos
            runs-on: macos-latest
            interpreter: 3.10 3.11 3.12 3.13 3.14

    runs-on: ${{ matrix.runs-on }}

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools

      - name: build PGO wheel
        id: pgo
        uses: ./.github/actions/build-pgo-wheel
        with:
          interpreter: ${{ matrix.interpreter }}
          rust-toolchain: stable

      - uses: actions/upload-artifact@v6
        with:
          name: pypi_files-${{ matrix.os }}-pgo
          path: ${{ steps.pgo.outputs.wheel-dir }}

  # Test wheels on exotic architectures via QEMU
  test-builds-arch:
    name: test build on ${{ matrix.target }}
    needs: [build]
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        target: [aarch64, armv7, s390x, ppc64le]

    steps:
      - uses: actions/checkout@v6

      - uses: actions/download-artifact@v4
        with:
          pattern: pypi_files-linux-${{ matrix.target }}-*
          merge-multiple: true
          path: dist

      - uses: uraimo/run-on-arch-action@v3
        name: install & test
        with:
          arch: ${{ matrix.target }}
          distro: ubuntu22.04
          dockerRunArgs: --volume "${{ github.workspace }}/dist:/dist"
          install: |
            apt-get update
            apt-get install -y --no-install-recommends python3 python3-pip python3-venv
          run: |
            ls -lh /dist/
            python3 -m venv venv
            source venv/bin/activate
            python3 -m pip install pydantic-monty --no-index --no-deps --find-links /dist --force-reinstall
            python3 -c "import pydantic_monty; print(pydantic_monty.Monty('1 + 2').run())"

  # Test wheels on main OS platforms
  test-builds-os:
    name: test build on ${{ matrix.os }}
    needs: [build, build-pgo]
    runs-on: ${{ matrix.runs-on }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            runs-on: ubuntu-latest
          - os: macos
            runs-on: macos-latest
          - os: windows
            runs-on: windows-latest

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - uses: actions/download-artifact@v4
        with:
          pattern: pypi_files-${{ matrix.os }}-*
          merge-multiple: true
          path: dist

      - run: pip install pydantic-monty --no-index --find-links dist --force-reinstall
      - run: python -c "import pydantic_monty; print(pydantic_monty.Monty('1 + 2').run())"

  # Inspect built artifacts
  inspect-python-assets:
    needs: [build, build-pgo, build-sdist]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v7
        with:
          pattern: pypi_files-*
          merge-multiple: true
          path: dist

      - name: list files
        run: |
          ls -lhR dist/
          ls -1 dist/ | wc -l
          echo "Expected ~50 wheel files (5 Python versions Ã— 10 platform variants)"

      - uses: astral-sh/setup-uv@v7
      - run: uvx twine check dist/*

  # Release to PyPI
  release-python:
    name: release to PyPI
    needs: [check, inspect-python-assets, test-builds-arch, test-builds-os]
    if: success() && startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest

    environment:
      name: release-python
      url: https://pypi.org/project/pydantic-monty/${{ steps.check-version.outputs.VERSION }}

    permissions:
      id-token: write

    steps:
      - uses: actions/checkout@v6
      - uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - uses: actions/download-artifact@v7
        with:
          pattern: pypi_files-*
          merge-multiple: true
          path: dist

      - id: check-version
        uses: samuelcolvin/check-python-version@v5
        with:
          version_file_path: "Cargo.toml"

      - run: ls -lhR dist/

      - name: Publish to PyPI
        run: "uv publish --trusted-publishing always dist/*"

  build-js:
    strategy:
      fail-fast: false
      matrix:
        settings:
          - host: macos-latest
            target: x86_64-apple-darwin
            build: npm run build -- --target x86_64-apple-darwin
          - host: windows-latest
            build: npm run build -- --target x86_64-pc-windows-msvc
            target: x86_64-pc-windows-msvc
          - host: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            build: npm run build -- --target x86_64-unknown-linux-gnu --use-napi-cross
          - host: macos-latest
            target: aarch64-apple-darwin
            build: npm run build -- --target aarch64-apple-darwin
          - host: ubuntu-latest
            target: wasm32-wasip1-threads
            build: npm run build -- --target wasm32-wasip1-threads
    name: build JS - ${{ matrix.settings.target }} - node@22
    runs-on: ${{ matrix.settings.host }}
    steps:
      - uses: actions/checkout@v6
      - name: Setup node
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: npm
          cache-dependency-path: crates/monty-js/package-lock.json
      - name: Install
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: ${{ matrix.settings.target }}
      - name: Cache cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            ~/.napi-rs
            .cargo-cache
            target/
          key: ${{ matrix.settings.target }}-cargo-${{ matrix.settings.host }}
      - uses: mlugg/setup-zig@v2
        if: ${{ contains(matrix.settings.target, 'musl') }}
        with:
          version: 0.14.1
      - name: Install cargo-zigbuild
        uses: taiki-e/install-action@v2
        if: ${{ contains(matrix.settings.target, 'musl') }}
        with:
          tool: cargo-zigbuild
      - name: Setup toolchain
        run: ${{ matrix.settings.setup }}
        if: ${{ matrix.settings.setup }}
        shell: bash
      - name: Install dependencies
        run: npm install
        working-directory: crates/monty-js
      - name: Build
        run: ${{ matrix.settings.build }}
        shell: bash
        working-directory: crates/monty-js
      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: js-bindings-${{ matrix.settings.target }}
          path: |
            crates/monty-js/monty.*.node
            crates/monty-js/monty.*.wasm
          if-no-files-found: error
      # need to upload the .js files generated by napi; they are identical for whatever target
      # so might as well upload from the linux job
      - if: ${{ matrix.settings.target == 'x86_64-unknown-linux-gnu' }}
        name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: js-stubs
          path: |
            crates/monty-js/browser.js
            crates/monty-js/index.js
            crates/monty-js/index.d.ts
            crates/monty-js/monty.wasi.cjs
            crates/monty-js/monty.wasi-browser.js
            crates/monty-js/wasi-worker.mjs
            crates/monty-js/wasi-worker-browser.mjs
          if-no-files-found: error
    env:
      MACOSX_DEPLOYMENT_TARGET: "10.13"
      CARGO_INCREMENTAL: "1"

  test-js-macOS-windows-binding:
    name: Test JS bindings on ${{ matrix.settings.target }} - node@${{ matrix.node }}
    needs:
      - build-js
    strategy:
      fail-fast: false
      matrix:
        settings:
          - host: windows-latest
            target: x86_64-pc-windows-msvc
            architecture: x64
          - host: macos-latest
            target: aarch64-apple-darwin
            architecture: arm64
          - host: macos-latest
            target: x86_64-apple-darwin
            architecture: x64
        node:
          - "20"
          - "22"
    runs-on: ${{ matrix.settings.host }}
    steps:
      - uses: actions/checkout@v6
      - name: Setup node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node }}
          cache: npm
          cache-dependency-path: crates/monty-js/package-lock.json
          architecture: ${{ matrix.settings.architecture }}
      - name: Install dependencies
        run: npm install
        working-directory: crates/monty-js
      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          name: js-bindings-${{ matrix.settings.target }}
          path: crates/monty-js
      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          name: js-stubs
          path: crates/monty-js
      - name: List packages
        run: ls -R .
        shell: bash
        working-directory: crates/monty-js
      - name: Test bindings
        run: npm test
        working-directory: crates/monty-js

  test-js-linux-binding:
    name: Test JS ${{ matrix.target }} - node@${{ matrix.node }}
    needs:
      - build-js
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64-unknown-linux-gnu
        node:
          - "20"
          - "22"
    runs-on: ${{ contains(matrix.target, 'aarch64') && 'ubuntu-24.04-arm' || 'ubuntu-latest' }}
    steps:
      - uses: actions/checkout@v6
      - name: Setup node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node }}
          cache: npm
          cache-dependency-path: crates/monty-js/package-lock.json
      - name: Output docker params
        id: docker
        run: |
          node -e "
            if ('${{ matrix.target }}'.startsWith('aarch64')) {
              console.log('PLATFORM=linux/arm64')
            } else if ('${{ matrix.target }}'.startsWith('armv7')) {
              console.log('PLATFORM=linux/arm/v7')
            } else {
              console.log('PLATFORM=linux/amd64')
            }
          " >> $GITHUB_OUTPUT
          node -e "
            if ('${{ matrix.target }}'.endsWith('-musl')) {
              console.log('IMAGE=node:${{ matrix.node }}-alpine')
            } else {
              console.log('IMAGE=node:${{ matrix.node }}-slim')
            }
          " >> $GITHUB_OUTPUT
      - name: Install dependencies
        run: npm install
        working-directory: crates/monty-js
      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          name: js-bindings-${{ matrix.target }}
          path: crates/monty-js
      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          name: js-stubs
          path: crates/monty-js
      - name: List packages
        run: ls -R .
        shell: bash
        working-directory: crates/monty-js
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        if: ${{ contains(matrix.target, 'armv7') }}
        with:
          platforms: all
      - run: docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
        if: ${{ contains(matrix.target, 'armv7') }}
      - name: Test bindings
        uses: addnab/docker-run-action@v3
        with:
          image: ${{ steps.docker.outputs.IMAGE }}
          options: "-v ${{ github.workspace }}:${{ github.workspace }} -w ${{ github.workspace }}/crates/monty-js --platform ${{ steps.docker.outputs.PLATFORM }}"
          run: npm test

  test-js-wasi:
    name: Test WASI target
    needs:
      - build-js
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Setup node
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: npm
          cache-dependency-path: crates/monty-js/package-lock.json
      - name: Install dependencies
        run: npm install --cpu wasm32
        working-directory: crates/monty-js
      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          name: js-bindings-wasm32-wasip1-threads
          path: crates/monty-js
      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          name: js-stubs
          path: crates/monty-js
      - name: List packages
        run: ls -R .
        shell: bash
        working-directory: crates/monty-js
      - name: Test bindings
        run: npm test
        env:
          NAPI_RS_FORCE_WASI: 1
        working-directory: crates/monty-js

  release-js:
    name: Release to NPM
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    needs:
      - check
      # make sure python release will work before publishing to npm
      - inspect-python-assets
      - test-js-macOS-windows-binding
      - test-js-linux-binding
      - test-js-wasi
    steps:
      - uses: actions/checkout@v6
      - name: Setup node
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: npm
          cache-dependency-path: crates/monty-js/package-lock.json
      - name: Install dependencies
        run: npm install
        working-directory: crates/monty-js
      - name: create npm dirs
        run: npm run create-npm-dirs
        working-directory: crates/monty-js
      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: js-bindings-*
          path: crates/monty-js/artifacts
          merge-multiple: true
      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          name: js-stubs
          path: crates/monty-js
      - name: Move artifacts
        run: npm run artifacts
        working-directory: crates/monty-js
      - name: List packages
        run: ls -R ./npm
        shell: bash
        working-directory: crates/monty-js
      - name: Publish
        run: |
          npm config set provenance true
          if git log -1 --pretty=%B | grep "^[0-9]\+\.[0-9]\+\.[0-9]\+$";
          then
            echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" >> ~/.npmrc
            npm publish --access public
          elif git log -1 --pretty=%B | grep "^[0-9]\+\.[0-9]\+\.[0-9]\+";
          then
            echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" >> ~/.npmrc
            npm publish --tag next --access public
          else
            echo "Not a release, skipping publish"
          fi
        working-directory: crates/monty-js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
